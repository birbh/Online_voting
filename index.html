<!DOCTYPE html>
<!--
  MIT License
  
  Copyright (c) 2026 Biraj Bhattarai
  
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  
  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Investigator - Real-Time Voting</title>
  <link rel="stylesheet" href="css/index.css">

</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <h1> CRIME SCENE INVESTIGATION üö®</h1>
      <p>‚ö†Ô∏è Who is the Culprit? Cast Your Accusation ‚ö†Ô∏è</p>
      <div class="header-actions">
        <a class="header-link" href="feedback.html">üìù Submit Evidence</a>
      </div>
    </div>

    <!-- Voting Section (Phase 1 - Primary) -->
    <div id="votingSection" class="voting-section">
      <div id="errorMessage"></div>
      <div id="votingGrid" class="voting-grid">
        <!-- Voting cards will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Compat SDK for Realtime Database) -->
  <!-- Configuration block with clear comments -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /* ===== FIREBASE CONFIGURATION ===== */
    // Initialize Firebase with your project credentials
    // Replace these values with your Firebase project configuration
    const firebaseConfig = {
  apiKey: "AIzaSyC1bxz29svF9y_5V-8VJz0NaMsIzVOAwhI",
  authDomain: "online-voting-b970f.firebaseapp.com",
  databaseURL: "https://online-voting-b970f-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "online-voting-b970f",
  storageBucket: "online-voting-b970f.firebasestorage.app",
  messagingSenderId: "784746686625",
  appId: "1:784746686625:web:eb6a565d11d7240d48a8e0"
};
    

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== SUSPECT DATA (4 Suspects - "Who is the Culprit?" Game) ===== */
    const suspectOptions = [
      {
        id: 'suspect1',
        name: 'Lydia Mercer',
        role: 'First Year Student',
        motive: 'age 23 - Campus access & knowledge',
        photoUrl: 'images/lydia.jpg'
      },
      {
        id: 'suspect2',
        name: 'Marco Vale',
        role: 'Final Year Student',
        motive: 'age 27 - Academic pressure & secrets',
        photoUrl: 'images/marco.jpg'
      },
      {
        id: 'suspect3',
        name: 'Noah Kade',
        role: 'Lab Assistant',
        motive: 'age 32 - Lab access & expertise',
        photoUrl: 'images/noah.jpg'
      },
      {
        id: 'suspect4',
        name: 'Theo Ash',
        role: 'Third Year Student',
        motive: 'age 25 - Hidden connections',
        photoUrl: 'images/theo.jpg'
      }
    ];

    let hasVoted = false;
    let currentVote = null;

    /* ===== INITIALIZE VOTING GRID ===== */
    function initializeVotingGrid() {
      const grid = document.getElementById('votingGrid');
      grid.innerHTML = ''; // Clear previous content

      suspectOptions.forEach(suspect => {
        const card = document.createElement('div');
        card.className = 'voting-card';
        card.innerHTML = `
          <div class="suspect-photo">
            <img src="${suspect.photoUrl}" alt="${suspect.name}" onerror="this.style.display='none'">
          </div>
          <div class="suspect-info">
            <div>
              <h3>${suspect.name}</h3>
              <p><strong>Role:</strong> ${suspect.role}</p>
              <p><strong>Motive:</strong> ${suspect.motive}</p>
            </div>
            <button class="vote-button" onclick="castVote('${suspect.id}', '${suspect.name}')">
              Accuse
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    /* ===== CAST VOTE (Firebase Transaction for Atomicity) ===== */
    function castVote(optionId, optionTitle) {
      if (hasVoted) {
        showError('You have already voted. Use ‚ÄúSubmit Evidence‚Äù to leave feedback.');
        return;
      }

      // Disable all buttons during transaction
      disableAllButtons();

      // Use Firebase transaction to ensure atomicity during high-traffic voting
      db.ref('votes/' + optionId).transaction(currentValue => {
        return (currentValue || 0) + 1;
      }).then(result => {
        if (result.committed) {
          hasVoted = true;
          currentVote = optionTitle;
          console.log(`‚úì Vote recorded for: ${optionTitle}`);
          window.location.href = `feedback.html?option=${encodeURIComponent(optionTitle)}`;
        }
      }).catch(error => {
        enableAllButtons();
        showError('Failed to cast vote. Please try again.');
        console.error('Transaction failed:', error);
      });
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
      setTimeout(() => {
        errorDiv.innerHTML = '';
      }, 5000);
    }

    function disableAllButtons() {
      document.querySelectorAll('.vote-button').forEach(btn => {
        btn.disabled = true;
      });
    }

    function enableAllButtons() {
      document.querySelectorAll('.vote-button').forEach(btn => {
        btn.disabled = false;
      });
    }

    /* ===== INITIALIZE ON PAGE LOAD ===== */
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üîç Digital Investigator - Participant Portal Initialized');
      initializeVotingGrid();
    });
  </script>
</body>
</html>

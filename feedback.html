<!DOCTYPE html>
<!--
  MIT License
  
  Copyright (c) 2026 Biraj Bhattarai
  
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  
  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Submit Evidence - Feedback</title>
  <link rel="stylesheet" href="css/feedback.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js"></script>
   
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš¨ Submit Evidence</h1>
      <p>ğŸ“ Provide feedback (no voting here)</p>
      <div class="header-actions">
        <a class="header-link" href="index.html">â¬…ï¸ Back to Voting</a>
        <a class="header-link" href="admin.html">ğŸ” Admin HUD</a>
      </div>
    </div>

    <div class="panel">
      <h2>Witness Statement</h2>

      <div id="messageArea"></div>

      <label for="suspectSelect">Suspect (optional)</label>
      <select id="suspectSelect" class="select">
        <option value="">â€” General feedback (no suspect) â€”</option>
      </select>

      <label for="feedbackTextarea">Your evidence / theory</label>
      <textarea
        id="feedbackTextarea"
        class="feedback-textarea"
        placeholder="WITNESS STATEMENT: Enter your evidence and theory about the crime..."
      ></textarea>

      <div class="button-row">
        <button id="submitBtn" class="button primary" type="button" onclick="submitFeedback()">ğŸ“‹ Submit Evidence</button>
        <button id="clearBtn" class="button" type="button" onclick="clearForm()">ğŸ§¹ Clear</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Compat SDK for Realtime Database) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    /* ===== FIREBASE CONFIGURATION ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyC1bxz29svF9y_5V-8VJz0NaMsIzVOAwhI",
      authDomain: "online-voting-b970f.firebaseapp.com",
      databaseURL: "https://online-voting-b970f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "online-voting-b970f",
      storageBucket: "online-voting-b970f.firebasestorage.app",
      messagingSenderId: "784746686625",
      appId: "1:784746686625:web:eb6a565d11d7240d48a8e0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Initialize App Check (optional but recommended for security)
    const appCheck = firebase.appCheck();
    appCheck.activate('6LfIVVssAAAAAG0wX3vjM0CAjMW8MJG4fKmzo5wR', true);

    const suspectOptions = [
      { id: 'suspect1', name: 'Lydia Mercer' },
      { id: 'suspect2', name: 'Marco Vale' },
      { id: 'suspect3', name: 'Noah Kade' },
      { id: 'suspect4', name: 'Theo Ash' }
    ];

    function setMessage(kind, text) {
      const area = document.getElementById('messageArea');
      if (!text) {
        area.innerHTML = '';
        return;
      }

      const safeText = String(text);
      area.innerHTML = `<div class="message ${kind}">${safeText}</div>`;
    }

    function disableButtons(disabled) {
      document.getElementById('submitBtn').disabled = disabled;
      document.getElementById('clearBtn').disabled = disabled;
      document.getElementById('suspectSelect').disabled = disabled;
      document.getElementById('feedbackTextarea').disabled = disabled;
    }

    function clearForm() {
      setMessage('', '');
      document.getElementById('feedbackTextarea').value = '';

      const select = document.getElementById('suspectSelect');
      if (!select.disabled) {
        select.value = '';
      }
    }

    function getPrefillOptionFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const option = (params.get('option') || '').trim();
      return option;
    }

    function initSuspectSelect() {
      const select = document.getElementById('suspectSelect');

      suspectOptions.forEach(opt => {
        const el = document.createElement('option');
        el.value = opt.name;
        el.textContent = opt.name;
        select.appendChild(el);
      });

      const prefill = getPrefillOptionFromUrl();
      if (prefill) {
        select.value = prefill;
        select.disabled = true;
        setMessage('success', `Accusation recorded: ${prefill}. Add your evidence below.`);
      }
    }

    function submitFeedback() {
      const select = document.getElementById('suspectSelect');
      const option = (select.value || '').trim();
      const feedbackText = document.getElementById('feedbackTextarea').value.trim();

      if (!feedbackText) {
        setMessage('error', 'Please enter your feedback before submitting.');
        return;
      }

      disableButtons(true);
      setMessage('', '');

      db.ref('feedback/').push({
        option: option || 'General',
        feedback: feedbackText,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        document.getElementById('feedbackTextarea').value = '';
        setMessage('success', 'Thank you! Your feedback has been recorded.');
        disableButtons(false);
      }).catch(error => {
        console.error('Feedback push failed:', error);
        setMessage('error', 'Failed to submit feedback. Please try again.');
        disableButtons(false);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initSuspectSelect();
      document.getElementById('feedbackTextarea').focus();
    });
  </script>
</body>
</html>
